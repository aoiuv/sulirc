## å‰è¨€

> æ—¶é—´æ˜¯ç¨‹åºé‡Œæœ€å¤æ‚çš„å› ç´ 

ç¼–å†™ Web åº”ç”¨çš„æ—¶å€™ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¤§å¤šæ—¶å€™å¤„ç†çš„éƒ½æ˜¯åŒæ­¥çš„ã€çº¿æ€§çš„ä¸šåŠ¡é€»è¾‘ã€‚ä½†æ˜¯æ­£å¦‚å¼€ç¯‡æ‰€è¯´çš„â€œæ—¶é—´æ˜¯ç¨‹åºé‡Œæœ€å¤æ‚çš„å› ç´ â€ï¼Œåº”ç”¨ä¸€æ—¦å¤æ‚ï¼Œå¾€å¾€ä¼šé­é‡å¾ˆå¤šå¼‚æ­¥é—®é¢˜ï¼Œå¦‚æœä»£ç ä¸­æ¶‰åŠåˆ°åˆ°å¤šä¸ªå¼‚æ­¥çš„æ—¶å€™ï¼Œè¿™æ—¶å€™å°±éœ€è¦æ…é‡è€ƒè™‘äº†ï¼Œæˆ‘ä»¬éœ€è¦çš„æ„è¯†åˆ°çš„æ˜¯ï¼š

åˆ°åº•æˆ‘ä»¬çš„å¼‚æ­¥é€»è¾‘æ˜¯æ˜“è¯»çš„ä¹ˆï¼Ÿå¯ç»´æŠ¤çš„ä¹ˆï¼Ÿå“ªäº›æ˜¯å¹¶å‘åœºæ™¯ï¼Œå“ªäº›æ˜¯ç«æ€åœºæ™¯ï¼Œæˆ‘ä»¬æœ‰ä»€ä¹ˆå¯¹ç­–ä¹ˆï¼Ÿä»¥ä¸‹æˆ‘å°†æŠ›å‡ºæˆ‘å‘ç°çš„å‡ ç§æ–¹æ¡ˆï¼Œæ³¨æ„ææç¥ï¼ä»¥ä¸‹å…¨ç¨‹éœ€è¦é›†ä¸­ç²¾ç¥æ€è€ƒ ğŸ¤”

## è§£å†³é—®é¢˜ä¹‹å‰

åœ¨æŠ›å‡ºå…·ä½“çš„è§£å†³é—®é¢˜çš„æŠ€æœ¯æ–¹æ¡ˆä¹‹å‰ã€‚é¦–å…ˆæ¢è®¨ä¸€ä¸‹æˆ‘ä»¬å¸¸è§çš„è¯·æ±‚ä¼šé‡åˆ°çš„é—®é¢˜ã€‚

### æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½æ˜¯ä¸€ä¸ªé‡å…½ï¼

ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨å‰ç«¯è€Œè¨€æˆ‘ä»¬ç»å¸¸é‡åˆ°çš„å¼‚æ­¥åœºæ™¯ï¼Œæ˜¯è¯·æ±‚é—®é¢˜ã€‚ï¼ˆå½“ç„¶å¯¹åº”åˆ°åç«¯ï¼Œæœ‰å¯èƒ½æ˜¯å„ç§ IO æ“ä½œï¼Œæ¯”å¦‚è¯»å†™æ–‡ä»¶ã€æ“ä½œæ•°æ®åº“ç­‰ï¼‰ã€‚

é‚£ç¬”è€…ä¸ºä½•è°ˆåˆ°è¯·æ±‚ï¼Œå› ä¸ºå¤§å¤šäººéƒ½ä¼šå¿½ç•¥æ­¤ç±»é—®é¢˜ã€‚æˆ‘ä»¬å¾€å¾€æœ‰æ—¶å€™ä¼šå‘å‡ºå¤šä¸ªåŒç±»å‹çš„è¯·æ±‚ï¼ˆä¸ä¸€å®šç¬¦åˆæˆ‘ä»¬æ„æ„¿ï¼‰ï¼Œä½†æ˜¯æ¯æ¯è§‰å¾—è‡ªå·±çš„åº”ç”¨ååˆ†å¥å£®ï¼Œå®é™…ä¸Šå¦‚æœæ²¡æœ‰å½“å¿ƒæ§åˆ¶â€œé‡å…½â€çš„è¯ï¼Œå®é™…ä¸Šåº”ç”¨ä¹Ÿä¼šç›¸å½“è„†å¼±ï¼

å¦‚ä¸‹å›¾ï¼Œåº”ç”¨ä¾ç…§ A1 -> A2 -> A3 é¡ºåºå‘èµ·è¯·æ±‚ï¼Œæˆ‘ä»¬ä¹ŸæœŸæœ›çš„æ˜¯ A1 -> A2 -> A3 çš„é¡ºåºè¿”å›å“åº”ç»™åº”ç”¨ã€‚

![](https://user-gold-cdn.xitu.io/2019/7/28/16c3798343115b98?w=570&h=296&f=png&s=11302)

ä½†å®é™…ä¸Šå‘¢ã€‚ä½†æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ååˆ†é‡æ€§çš„ã€‚æˆ‘ä»¬æ ¹æœ¬æ— æ³•æŠŠæ§å®ƒå“ªæ—¶å€™å›æ¥ï¼è¯·æ±‚çš„å“åº”é¡ºåºæå¤§ç¨‹åº¦ä¾èµ–ç”¨æˆ·çš„ç½‘ç»œç¯å¢ƒã€‚æ¯”å¦‚ä¸Šå›¾çš„å“åº”é¡ºåºå®é™…ä¸Šå°±æ˜¯ A3 -> A1 -> A2ï¼Œæ­¤æ—¶åº”ç”¨å°†æœ‰æ¦‚ç‡ä¼šå˜å¾—ä¸€å›¢ç³Ÿï¼

ä¸è¿‡ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œå®é™…ä¸Šï¼Œä¸€æ—¦å½“ä½ æ³¨æ„é—®é¢˜çš„æ—¶å€™ï¼Œå…¶å®å°±ç¦»è§£å†³é—®é¢˜ä¸è¿œäº†ã€‚

é‚£ä¹ˆæˆ‘ä»¬å¸¸è§çš„åšæ³•ä¼šæœ‰ä»€ä¹ˆå‘¢ï¼Ÿ

### ç»“æŸæ ‡è®°

é€šè¿‡åº”ç”¨ä¸­çš„æ ‡è®°çŠ¶æ€ï¼Œåœ¨éœ€æ±‚è¯·æ±‚å®Œæˆåï¼Œæ ‡è®°æˆåŠŸï¼Œå¿½ç•¥å¤šä½™è¯·æ±‚ï¼Œå¯ä»¥å·§å¦™é¿å¼€è¯·æ±‚ç«æ€çš„é™·é˜±ã€‚ç”±äºæ­¤å†™æ³•æ¯”è¾ƒå¸¸è§ï¼Œä¸å†èµ˜è¿°ã€‚

### é˜Ÿåˆ—åŒ–

å°†è¯·æ±‚ä¸²è¡Œï¼æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨ã€‚åœ¨æ—¶é—´çº¿ä¸Šå°†å¤šä¸ªå¼‚æ­¥æ‹å¹³æˆä¸€æ¡çº¿ã€‚é‡å…½è¯·æ±‚ä»¬ä¾åºè¿›å…¥é˜Ÿåˆ—ï¼ˆç›¸å½“äºæˆ‘ä»¬ç»™è¯·æ±‚ä»¬æ‹‰èµ·äº†ç¼°ç»³ï¼Œåˆ’å¥½äº†å¥”è·‘çš„é“è·¯ï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://user-gold-cdn.xitu.io/2019/7/28/16c3799b0ac74faa?w=1140&h=296&f=png&s=15306)

åªæœ‰å½“ A1 è¯·æ±‚å“åº”æ—¶ï¼Œæ‰è¿›è¡Œ A2 è¯·æ±‚ï¼ŒA2 å“åº”æˆåŠŸæ—¶ï¼Œè¿›è¡Œ A3 è¯·æ±‚ã€‚åŒç†ä»¥æ­¤ç±»æ¨ã€‚ï¼ˆæ³¨æ„è™½ç„¶è¯·æ±‚çš„é¡ºåºå¼ºè¡Œè¢«ä¿®æ”¹ä¸ºä¸²è¡Œï¼Œä½†å¹¶ä¸æ„å‘³è¿™å‘èµ·è¯·æ±‚çš„åŠ¨ä½œä¹Ÿæ˜¯ä¸²è¡Œï¼‰ã€‚å› æ­¤åœ¨ä»æ—¶é—´ç»´åº¦ä¸Šå¤§å¤§ç®€åŒ–äº†åœºæ™¯ï¼Œæå¤§çš„å‡å°‘äº† bug çš„å‘ç”Ÿæ¦‚ç‡ã€‚

ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¯·æ±‚ä¸²è¡Œåé˜»å¡äº†ï¼ŒæŸäº›åœºæ™¯ä¸‹ä¹Ÿè®¸åšäº†å¾ˆå¤šæ— ç”¨åŠŸã€‚

### å–æ¶ˆè¯·æ±‚ + æœ€æ–°

æœ‰åŒå­¦ä»¬å°±ä¼šè§‰å¾—ï¼Œæ•ˆç‡æ˜¯å¦ç•¥æ˜¾ä½ä¸‹ï¼Œæ—¢ç„¶æˆ‘ä»¬å‰é¢çš„è¯·æ±‚è™½ç„¶ä¾åºç”Ÿæ•ˆäº†ï¼Œä½†æ˜¯æœ€ç»ˆå¾ˆå¿«éƒ½ä¼šè¢«æœ€æ–°çš„è¯·æ±‚ç»“æœæ‰€æ›¿æ¢ï¼Œé‚£ä¹ˆè¿˜åšé‚£ä¹ˆå¤šæ— ç”¨åŠŸå¹²å˜›ï¼Ÿæ˜¯çš„ï¼Œçš„ç¡®ä¸åº”å½“è¿™ä¹ˆåšï¼å¦‚å›¾ï¼š

![](https://user-gold-cdn.xitu.io/2019/7/28/16c379b0aedb68f2?w=564&h=298&f=png&s=14516)

å‡¡æ˜¯æœ‰æ–°çš„è¯·æ±‚äº§ç”Ÿï¼Œå–æ¶ˆä¸Šä¸€ä¸ªè¿˜åœ¨è·¯ä¸Šçš„è¯·æ±‚ï¼ˆåŸç”Ÿçš„ XMLHttpRequest.abort()ã€axios çš„ cancelTokenï¼‰ï¼Œç„¶ååªå–æœ€æ–°çš„ä¸€ä¸ªè¯·æ±‚ï¼Œé™é™ç­‰å¾…å®ƒçš„å“åº”ã€‚æ¯”å¦‚ redux-saga ä¸­ takeLatestã€‚

ï¼ˆä½†æ˜¯è¯·åŒå­¦ä»¬æ³¨æ„ï¼Œå¦‚æœéœ€è¦æ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¯¹æœåŠ¡å™¨äº§ç”Ÿæ•ˆæœï¼Œæ¯”å¦‚ POST è¯·æ±‚ç­‰ï¼Œæœ‰æ—¶å€™é˜Ÿåˆ—ä¹Ÿä¸å¤±ä¸ºä¸€ä¸ªå¥½çš„è§£å†³æ–¹å¼ï¼‰

## é—®é¢˜ä»¥åŠèƒŒæ™¯

ä¸Šæ–‡å…¶å®ç®—æ˜¯ä¸€ä¸ªå¼•å­ï¼Œæ¥ä¸‹æ¥æˆ‘å°†å¹¶å‘ç«æ€çš„é—®é¢˜æŠ½è±¡ç®€åŒ–ä¸ºä»¥ä¸‹ä»£ç ï¼Œè¯·çœ‹ï¼š

```js
// æ¨¡æ‹Ÿäº†ä¸€ä¸ª ajax è¯·æ±‚å‡½æ•°ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚æœ‰ä¸€ä¸ªéšæœºå»¶æ—¶
function ajax(url, cb) {
  let fake_responses = {
    file1: "The first text",
    file2: "The middle text",
    file3: "The last text"
  };
  let wait = (Math.round(Math.random() * 1e4) % 8000) + 1000;

  console.log("Requesting: " + url + `, time cost: ${wait} ms`);

  setTimeout(() => {
    cb(fake_responses[url]);
  }, wait);
}

function output(text) {
  console.log(text);
}
```

é‚£ä¹ˆå¦‚ä½•å®ç°ä¸€ä¸ª getFile å‡½æ•°ï¼Œä½¿å¾—å¯ä»¥å¹¶è¡Œè¯·æ±‚ï¼Œç„¶åä¾ç…§è¯·æ±‚é¡ºåºæ‰“å°å“åº”çš„å€¼ï¼Œæœ€ç»ˆå¼‚æ­¥å®Œæˆåæ‰“å°å®Œæˆã€‚ï¼ˆæ³¨æ„ï¼Œæ­¤å¤„è€ƒè™‘å¹¶å‘åœºæ™¯ï¼‰

```js
getFile("file1");
getFile("file2");
getFile("file3");
```

æœŸæœ›ç»“æœï¼š

```bash
Requesting: file1, time cost: 8233 ms
Requesting: file2, time cost: 2581 ms
Requesting: file3, time cost: 7334 ms
The first text
The middle text
The last text
Complete!
get files total time: 8247.093ms
```

ä¸‹æ–‡å°†å’Œå¤§å®¶ä»‹ç»ä»ç¼–å†™å®ç°ä¸Šå¦‚ä½•è§£å†³å¹¶å‘ç«æ€çš„é—®é¢˜çš„å‡ ç§æ–¹æ¡ˆï¼

## è§£å†³æ–¹æ¡ˆï¼šThunks

### ä»€ä¹ˆæ˜¯ Thunk

Thunk è¿™ä¸ªè¯æ˜¯èµ·æºäºâ€œæ€è€ƒâ€çš„å¹½é»˜è¿‡å»å¼çš„æ„æ€ã€‚å®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå»¶è¿Ÿæ‰§è¡Œè®¡ç®—çš„å‡½æ•°ã€‚æ¯”å¦‚ä¸‹è¿°ï¼š

```js
// å¯¹äºä¸‹è¿° 1 + 2 è®¡ç®—æ˜¯å³æ—¶çš„
// x === 3
let x = 1 + 2;

// 1 + 2 çš„è®¡ç®—æ˜¯å»¶è¿Ÿçš„
// å‡½æ•° foo å¯ä»¥ç¨åè°ƒç”¨è¿›è¡Œå€¼çš„è®¡ç®—
// æ‰€ä»¥å‡½æ•° foo å°±æ˜¯ä¸€ä¸ª thunk
let foo = () => 1 + 2;
```

é‚£ä¹ˆæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª getFile å‡½æ•°å¦‚ä¸‹ï¼š

```js
function getFile(file) {
  let resp;

  ajax(file, text => {
    if (resp) resp(text);
    else resp = text;
  });

  return function thunk(cb) {
    if (resp) cb(resp);
    else resp = cb;
  };
}
```

æ³¨æ„æˆ‘ä»¬å¦‚ä¸Šæœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„å®ç°ï¼Œå®é™…ä¸Šåœ¨è°ƒç”¨ getFile å‡½æ•°çš„æ—¶å€™ï¼Œå†…éƒ¨å°±å·²ç»å‘ç”Ÿäº† ajax è¯·æ±‚ï¼ˆå› æ­¤è¯·æ±‚å¹¶æ²¡æœ‰è¢«é˜»å¡ï¼‰ï¼Œä½†æ˜¯çœŸæ­£è¿”å›å“åº”çš„é€»è¾‘æ”¾åœ¨äº† thunk ä¸­ã€‚

å› æ­¤ï¼Œä¸šåŠ¡é€»è¾‘å¦‚ä¸‹ï¼š

```js
let thunk1 = getFile("file1");
let thunk2 = getFile("file2");
let thunk3 = getFile("file3");

thunk1(text => {
  output(text);
  thunk2(text => {
    output(text);
    thunk3(text => {
      output(text);
      output("Complete!");
    });
  });
});
```

è°ƒç”¨åï¼Œå¾ˆå¥½å®ç°äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼ä½†æ˜¯ï¼ä½†æ˜¯åŒå­¦ä»¬ä¹Ÿå‘ç°äº†ï¼Œè¿˜æ˜¯éš¾å…é™·å…¥äº†å›è°ƒåœ°ç‹±ï¼Œå†™æ³•è¿˜æ˜¯ä¸å¥½ç»´æŠ¤ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œè¿˜æ˜¯ä¸å¤Ÿä¼˜é›…~

å—¯...æœ‰ä»€ä¹ˆåŠæ³•å‘¢ï¼Ÿ

### ä¸­é—´ä»¶

è¿‘å‡ å¹´ï¼Œä¸­é—´ä»¶çš„æ€æƒ³å’Œä½¿ç”¨ååˆ†æµè¡Œï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨ä¸­é—´ä»¶æ–¹å¼å®ç°ä¸€ä¸‹ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„ compose å‡½æ•°å¦‚ä¸‹ï¼ˆå½“ç„¶æ­¤åœºæ™¯ä¸‹æˆ‘ä»¬å¹¶ä¸å…³æ³¨ä¸­é—´ä»¶çš„ä¸Šä¸‹æ–‡ï¼Œå› æ­¤ç®€åŒ–å…¶å®ç°ï¼‰ï¼š

```js
function compose(...mdws) {
  return () => {
    function next() {
      const mdw = mdws.shift();
      mdw && mdw(next);
    }
    mdws.shift()(next);
  };
}
```

é‚£æˆ‘ä»¬çš„ getFile å‡½æ•°å®ç°ä¹Ÿå¾—ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œè®©è¿”å›çš„ thunk å‡½æ•°å¯ä»¥äº¤ç”±ä¸­é—´ä»¶çš„ next æ§åˆ¶ï¼š

```js
function getFileMiddleware(file, cb) {
  let resp;

  ajax(file, function(text) {
    if (!resp) resp = text;
    else resp(text);
  });

  return next => {
    _next = args => {
      cb && cb(args);
      next(args);
    };
    if (resp) {
      _next(resp);
    } else {
      resp = _next;
    }
  };
}
```

åŸºäºä¸Šè¿°ä¸¤ä¸ªå®ç°ã€‚æˆ‘ä»¬æœ€ç»ˆçš„å†™æ³•å¯ä»¥ä¿®æ”¹ä¸ºä»¥ä¸‹å½¢å¼ï¼š

```js
const middlewares = [
  getFileMiddleware("file1", output),
  getFileMiddleware("file2", output),
  getFileMiddleware("file3", resp => {
    output(resp);
    output("Complete!");
  })
];

compose(...middlewares)();
```

æœ€ç»ˆè¾“å‡ºç»“æœä»ç„¶æ»¡è¶³æˆ‘ä»¬å¯¹å¹¶å‘æ§åˆ¶çš„éœ€æ±‚ï¼ä½†æ˜¯å†™æ³•ä¸Šä¼˜é›…äº†ä¸å°‘ï¼ç¯‡å¹…æœ‰é™ï¼Œå°±ä¸è´´ä¸Šç»“æœäº†ï¼ŒåŒå­¦ä»¬å¯éªŒè¯ä¸€ä¸‹~

## è§£å†³æ–¹æ¡ˆï¼šPromises

åˆ°ç›®å‰ä¸ºæ­¢ã€‚æˆ‘ä»¬éƒ½æ²¡æœ‰å¥½å¥½åˆ©ç”¨ JavaScript é€ç»™æˆ‘ä»¬çš„ç¤¼ç‰©â€œPromiseâ€ã€‚Promise æ˜¯ä¸€ä¸ªå¯¹æœªæ¥çš„å€¼çš„å®¹å™¨ã€‚åˆ©ç”¨ Promise ä¹Ÿèƒ½å¾ˆå¥½çš„å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

å¦‚ä¸‹ï¼Œå®ç° getFile å‡½æ•°ï¼š

```js
function getFile(file) {
  return new Promise(function(resolve) {
    ajax(file, resolve);
  });
}
```

æ¥æ¥æ¥ï¼Œè°ƒç”¨ä¸€ä¸‹

```js
const p1 = getFile("file1");
const p2 = getFile("file2");
const p3 = getFile("file3");

p1.then(t1 => {
  output(t1);
  p2.then(t2 => {
    output(t2);
    p3.then(t3 => {
      output(t3);
      output("Complete!");
    });
  });
});
```

ä¸€æ ·æ»¡è¶³ï¼Œä½†æ˜¯ï¼Ÿæˆ‘ä»¬åˆé™·å…¥äº† Promise åœ°ç‹±...

### å¯¹ Promise åœ°ç‹± Say NO

å¦‚æœå†™å‡ºäº†ä¸Šè¿°çš„ Promise åœ°ç‹±ï¼Œè¯æ˜å¯¹ Promise çš„äº†è§£è¿˜ä¸å¤Ÿï¼Œäº‹å®ä¸Šä¹ŸèƒŒç¦»äº† Promise çš„è®¾è®¡åˆè¡·ã€‚æˆ‘ä»¬å¯ä»¥æ”¹ä¸ºä¸‹è¿°å†™æ³•ï¼š

```js
const p1 = getFile("file1");
const p2 = getFile("file2");
const p3 = getFile("file3");
const constant = v => () => v;

p1.then(output)
  .then(constant(p2))
  .then(output)
  .then(constant(p3))
  .then(output)
  .then(() => {
    output("Complete!");
  });
```

å—¯å“¼~åˆæ›´åŠ ä¼˜é›…äº†ç‚¹ã€‚Promise åœ°ç‹±ä¸è§å•¦~

### æ›´åŠ å‡½æ•°å¼çš„ Promise æ–¹å¼

é¦–å…ˆæˆ‘è¦æ‰¿è®¤ã€‚æˆ‘ç°åœ¨æ˜¯ï¼Œæœªæ¥ä¹Ÿæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„å¿ å®æ‹¥æŠ¤è€…ã€‚å› æ­¤ä¸Šè¿°å†™æ³•è™½ç„¶å‡å°‘äº†åµŒå¥—ï¼Œä½†æ˜¯è¿˜æ˜¯è§‰å¾—ç•¥æ˜¾æ— èŠï¼Œå¦‚æœæœ‰ä¸€ç™¾ä¸ªæ–‡ä»¶ç­‰å¾…è¯·æ±‚ï¼Œéš¾é“æˆ‘ä»¬è¿˜æœ‰æ‰‹å†™ä¸€ç™¾ä¸ª getFileï¼Œè¿˜æœ‰æ•°ä¸æ¸…çš„ then ä¹ˆï¼Ÿ

é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å†ä¸€æ­¥æ”¹è¿›å‘¢ï¼Ÿæˆ‘ä»¬å¥½å¥½æ€è€ƒä¸€ä¸‹ã€‚

é¦–å…ˆä»–ä»¬æ˜¯ä¸€ä¸ªé‡å¤çš„äº‹æƒ…ï¼Œæ—¢ç„¶é‡å¤é‚£å°±å¯ä»¥æŠ½è±¡ï¼Œåœ¨åŠ ä¸Šæˆ‘ä»¬å‡½æ•°å¼å·¥å…· reduce æ–¹æ³•ï¼Œæ”¹è¿›å¦‚ä¸‹ï¼š

```js
const urls = ["file1", "file2", "file3"];
const getFilePromises = urls.map(getFile);
const constant = v => () => v;

getFilePromises
  .concat(Promise.resolve("Complete!"), Promise.resolve())
  .reduce((chain, filePromise) => {
    return chain.then(output).then(constant(filePromise));
  });
```

é—®é¢˜è§£å†³ï¼Œå¹¶ä¸”ä¼˜é›…~ï¼ˆåŒå­¦ä»¬å¯èƒ½ç•™æ„åˆ°æˆ‘ concat äº†ä¸€ä¸ª Promise.resolveï¼Œæ˜¯å› ä¸ºæ­¤å¤„ reduce ä¸­æ€»éœ€è¦ä¸‹ä¸ª Promise æ‰¿æ¥ä¸Šä¸€ä¸ªçš„å€¼è¿›è¡Œæ‰§è¡Œï¼Œç»†èŠ‚å®ç°é—®é¢˜ï¼Œæ— éœ€ä»‹æ„ï¼‰ã€‚

## è§£å†³æ–¹æ¡ˆï¼šGenerators

> Generator æ˜¯çŠ¶æ€æœºçš„ä¸€ç§è¯­æ³•å½¢å¼ã€‚

ES6 ä¸­è¿˜æœ‰ä¸€ä¸ªè§£å†³å¼‚æ­¥é—®é¢˜çš„æ–°æœ‹å‹ generatorã€‚åŒç†æˆ‘ä»¬æ¥ç”¨ generator æ¥å®ç°éœ€æ±‚ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ co æ¥ç®€åŒ– generator çš„è°ƒç”¨ã€‚

```js
const co = require("co");

function getFile(file) {
  return new Promise(function(resolve) {
    ajax(file, resolve);
  });
}

function* loadFiles() {
  const p1 = getFile("file1");
  const p2 = getFile("file2");
  const p3 = getFile("file3");

  output(yield p1);
  output(yield p2);
  output(yield p3);

  output("Complete!");
}

co(loadFiles);
```

ä¸€æ ·çš„å®Œæˆäº†éœ€æ±‚ï¼Œæˆ‘ä»¬åˆå¤šäº†ä¸€ç§è§£å†³é—®é¢˜çš„æ€è·¯å¯¹å§~ generator å…¶å®åœ¨è§£å†³å¼‚æ­¥é—®é¢˜ä¸Šçš„èƒ½é‡è¶…ä¹æƒ³è±¡ã€‚å€¼å¾—æˆ‘ä»¬èŠ±è´¹å¤šç‚¹æ—¶é—´å­¦ä¹ ï¼

ç­‰ç­‰ï¼Œè²Œä¼¼æˆ‘ä»¬åœ¨ç¡¬ç¼–ç ï¼Œå†æ”¹è¿›ä¸€ä¸‹å§~

```js
function loadFiles(urls) {
  const getFilePromises = urls.map(getFile);
  return function* gen() {
    do {
      output(yield getFilePromises.shift());
    } while (getFilePromises.length > 0);

    output("Complete!");
  };
}

co(loadFiles(["file1", "file2", "file3"]));
```

å¥½å•¦ï¼Perfect~

## è§£å†³æ–¹æ¡ˆï¼šasync/await

æ—¢ç„¶å†™åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿç”¨ ES7 ä¸­å‡ºç°çš„ async/await å†™ä¸€ä¸‹å®ç°æ–¹æ¡ˆå§ï¼

```js
async function loadFiles(urls) {
  const getFilePromises = urls.map(getFile);
  do {
    const res = await getFilePromises.shift();
    output(res);
  } while (getFilePromises.length > 0);

  output("Complete!");
}

loadFiles(["file1", "file2", "file3"]);
```

å½“ç„¶ï¼Œå…¶å®å’Œ generator çš„å®ç°å†™æ³•ä¸Šå¤§è‡´æ— ä»€ä¹ˆå·®å¼‚ï¼Œä½†æ˜¯åœ¨å†™æ³•ä¸Šæå‡äº†å¯è¯»æ€§~

## å°ç»“

å…³äºå¼‚æ­¥è¯·æ±‚ï¼Œæ˜¯æ˜æ˜¾çš„å‰¯ä½œç”¨ï¼Œå¯è°“åå‰¯å…¶å®çš„â€œé‡å…½â€ã€‚é™¤äº†ä¸Šè¿°æåˆ°çš„ä¸€äº›æ–¹æ³•å¤–ï¼Œæˆ‘ä»¬åº”è¯¥æ°¸ä¸åœæ­¢å¯»æ‰¾æ›´å¥½æ›´ä¼˜é›…çš„èŒƒå¼å»å¤„ç†è¿™ç±»æƒ…å†µï¼Œæ¯”å¦‚å“åº”å¼ç¼–ç¨‹ã€äº¦æˆ–è€…å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ IO functor ç­‰ã€‚

å¯¹å¼‚æ­¥çš„æŒæ§ä¹Ÿè®¸è¿˜éœ€è¦æˆ‘ä»¬äº†è§£ JavaScript äº‹ä»¶å¾ªç¯ã€ä»»åŠ¡é˜Ÿåˆ—ã€RxJS ç­‰ç›¸å…³çŸ¥è¯†ã€è¿˜æ˜¯è¦å»å­¦ä¹ æ›´å¤šèŒƒå¼å’Œæ€ç»´æ–¹å¼ï¼Œä¸æ—¶é—´äº¤æœ‹å‹ï¼Œè€Œä¸æ˜¯ä¸ä¹‹ä¸ºæ•Œã€‚

ä»¥ä¸Šã€‚å¯¹å¤§å®¶å¦‚æœ‰åŠ©ç›Šï¼Œä¸èƒœè£å¹¸ã€‚

## å‚è€ƒèµ„æ–™

- [what-is-a-thunk](https://daveceddia.com/what-is-a-thunk/)
- [Stack Overflow: Dispatching Redux Actions with a Timeout](https://stackoverflow.com/questions/35411423/how-to-dispatch-a-redux-action-with-a-timeout/35415559#35415559)
- [Stack Overflow: Why do we need middleware for async flow in Redux?](https://stackoverflow.com/questions/34570758/why-do-we-need-middleware-for-async-flow-in-redux/34599594#34599594)
- [co](https://github.com/tj/co)
- [ES6 Generators: Complete Series](https://davidwalsh.name/es6-generators)
- [3 cases where JavaScript generators rock (+ understanding them)](https://goshakkk.name/javascript-generators-understanding-sample-use-cases/)
- [the-definitive-guide-to-the-javascript-generators](https://github.com/gajus/gajus.com-blog/blob/master/posts/the-definitive-guide-to-the-javascript-generators/index.md)
- [ES6 generators in depth](https://2ality.com/2015/03/es6-generators.html)
- [Race Conditions in JavaScript Apps by Thai Pangsakulyanont | JSConf.Asia 2019](https://www.youtube.com/watch?v=DWZj56qUNfs&feature=push-sd&attr_tag=_-nKBHAQrlEqNBVw%3A6)
- [redux-thunk](https://github.com/reduxjs/redux-thunk)
- [What the heck is the event loop anyway? - Philip Roberts - JSConf EU 2014](https://www.youtube.com/watch?v=8aGhZQkoFbQ)
- [Further Adventures of the Event Loop - Erin Zimmer - JSConf EU 2018](https://www.youtube.com/watch?v=u1kqx6AenYw)
